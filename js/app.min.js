const GLYPH_W=48,GLYPH_H=52,GLYPH_MARGIN=1,SPACE_SIZE=10,NAME_POS_X_START=100,NAME_POS_X_END=495,NAME_POS_Y=222,TEXT_POS_X=305,TEXT_POS_Y=305,MAX_TEXT_ROW=3,DEBUG=!1;function log(t){DEBUG&&console.log(t)}function loadImage(r){return new Promise((t,e)=>{const a=new Image;a.onload=()=>t(a),a.onabort=t=>e(t),a.src=r})}function createCanvas(t,e){var a=document.createElement("canvas");return a.width=t,a.height=e,[a,a.getContext("2d",{willReadFrequently:!0})]}function trim(t){for(var e,a,r=t.getContext("2d"),i=document.createElement("canvas").getContext("2d"),o=r.getImageData(0,0,t.width,t.height),n=o.data.length,s={top:null,left:null,right:null,bottom:null},l=0;l<n;l+=4)0!==o.data[l+3]&&(e=l/4%t.width,a=~~(l/4/t.width),null===s.top&&(s.top=a),(null===s.left||e<s.left)&&(s.left=e),(null===s.right||s.right<e)&&(s.right=e),null===s.bottom||s.bottom<a)&&(s.bottom=a);var g=s.right+1-s.left,r=r.getImageData(s.left,0,g,t.height);return i.canvas.width=g,i.canvas.height=t.height,i.putImageData(r,0,0),i.canvas}new Vue({el:"#app",data:{portraits:{},glyphs:{},resources:{},name:null,portrait:null,emotion:null,text:null,name_error:null,text_error:null,canvas:null,ctx:null,loading:!0},mounted(){this.init()},methods:{async init(){log("Loading meta data..."),this.portraits=await(await fetch("data\\portrait_meta.json")).json(),this.glyphs=await(await fetch("data\\glyph_meta.json")).json(),log("Done."),log("Initialize canvas and context..."),this.canvas=this.$refs.canvas,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),log("Done."),log("Loading resources..."),this.resources.textBox=await loadImage("img/textbox.png"),this.resources.fontColored=await loadImage("img/fc.png"),this.resources.font=await loadImage("img/f.png"),this.resources.mask=await loadImage("img/mask.png"),this.resources.portrait=await loadImage("img/portraits/Anna/0.png"),log("Done."),log("Set default values..."),this.portrait=this.name="Anna",this.emotion=0,this.text="Welcome!",log("Done."),this.render()},render(){this.loading=!0,log("Rendering..."),log("Clearing canvas..."),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),log("Done."),log("Drawing..."),this.ctx.drawImage(this.resources.textBox,0,0),this.drawName(this.name),this.drawText(this.text),this.drawPortrait(this.resources.portrait),log("Done."),this.loading=!1,log("=========================================")},rowLimit(t){if("Enter"==t.code&&this.text.split("\n").length==MAX_TEXT_ROW)return t.preventDefault(),!1},download(t){t.target.download=this.name+".png",t.target.href=this.canvas.toDataURL("image/png").replace("image/png","image/octet-stream")},drawName(e){if(""!=e){var a=[];for(let t=0;t<e.length;t++)if(" "==e[t])a.push(createCanvas(SPACE_SIZE,GLYPH_H)[0]);else{var[r,i]=createCanvas(GLYPH_W,GLYPH_H),o=this.glyphs[e[t]];if(null==o)return void(this.name_error="Unknown glyph. See glyph_meta.json");this.name_error="",i.drawImage(this.resources.font,o[0]*GLYPH_W,o[1]*GLYPH_H,GLYPH_W,GLYPH_H,0,0,GLYPH_W,GLYPH_H),a.push(trim(r))}var n=a.map(t=>t.width).reduce((t,e)=>t+e);let t=(NAME_POS_X_END-NAME_POS_X_START-n)/2+NAME_POS_X_START;log("Drawing name: "+e);for(const s of a)this.ctx.drawImage(s,t,NAME_POS_Y),t+=s.width}},drawText(r){if(""!=r){let e=TEXT_POS_X,a=TEXT_POS_Y;for(let t=0;t<r.length;t++)if("\n"==r[t])e=TEXT_POS_X,a+=GLYPH_H;else if(" "==r[t])e+=SPACE_SIZE;else{var[i,o]=createCanvas(GLYPH_W,GLYPH_H),n=this.glyphs[r[t]];if(null==n)return console.log(n),void(this.text_error="Unknown glyph. See glyph_meta.json");this.text_error="",o.drawImage(this.resources.fontColored,n[0]*GLYPH_W,n[1]*GLYPH_H,GLYPH_W,GLYPH_H,0,0,GLYPH_W,GLYPH_H);o=trim(i);this.ctx.drawImage(o,e,a),e+=o.width+GLYPH_MARGIN}log("Drawing text: "+r)}},drawPortrait(t){log("Drawing portrait...");var[e,a]=createCanvas(t.width,t.height);a.drawImage(this.resources.mask,0,0),a.globalCompositeOperation="source-in",a.drawImage(t,0,0),this.ctx.drawImage(e,1200,0)},async updatePortrait(){this.emotion=0,this.resources.portrait=await loadImage(`img\\portraits\\${this.portrait}\\${this.emotion}.png`),this.render()},async updateEmotion(){this.resources.portrait=await loadImage(`img\\portraits\\${this.portrait}\\${this.emotion}.png`),this.render()}}});